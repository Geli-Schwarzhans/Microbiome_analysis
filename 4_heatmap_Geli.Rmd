---
title: "pheatmap demo"
author: "Bela Hausmann (Joint Microbiome Facility)"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
editor_options: 
  chunk_output_type: console
---

# remove all the objects from the R session
```{r}
rm(list=ls())#rmove all data
```

```{r}
source("0_common.R", chdir = TRUE)
library(mia)
library(pheatmap)
library(gplots)
```


# Load containers
```{r}
SE_abs <- readRDS(file.path(RD_DIR, "SE_abs_all_finalremovedSamples.rds"))

SE <- SE_abs[, SE_abs$collection_date %in% c("0","5", "11","20", "35")]
SE <- SE_abs[, SE_abs$Species %in% c("UV7")]


# Get the 'Family' column from the rowData of 'SE'
family_column <- rowData(SE)$Family
domain_column <- rowData(SE)$Domain
# Extract unique names listed under 'Family'
unique_family_names <- unique(family_column)

# Print the unique family names
print(unique_family_names)
```

```{r}
# let's remind ourselves which assay we have available to us
assayNames(SE)
# make custom order of the Samples
SE$collection_date <- factor(SE$collection_date, levels =c("0","5", "11","20", "35"))
```

```{r}
#file1 <- file.path(DiffAbund_DIR, "SC_Ac_DESeq2_results_in_a_loop.tsv")
#DESeq2_results1 <- fread(file1)
#file2 <- file.path(DiffAbund_DIR, "SC_E25_DESeq2_results_in_a_loop.tsv")
#DESeq2_results2 <- fread(file2)
#file3 <- file.path(DiffAbund_DIR, "SC_UV7_DESeq2_results_in_a_loop.tsv")
#DESeq2_results3 <- fread(file3)

file1 <- file.path(DiffAbund_DIR, "Ac_E25_DESeq2_results_in_a_loop.tsv")
DESeq2_results1 <- fread(file1)
file2 <- file.path(DiffAbund_DIR, "Ac_UV7_DESeq2_results_in_a_loop.tsv")
DESeq2_results2 <- fread(file2)
file3 <- file.path(DiffAbund_DIR, "SC_Ac_DESeq2_results_in_a_loop.tsv")
DESeq2_results3 <- fread(file3)

```



# filter the DESeq results by p-value and merge with taxonomix information

```{r}
#Extract the row data from the SE object
taxonomy_dt <- as.data.table(as.data.frame(rowData(SE)), keep.rownames = "Feature_ID")

DESeq2_results1[padj <= 0.05][order(-abs(log2FoldChange))] %>% head(20)

DESeq2_results1[padj <= 0.05, .(.N), by = .(Collection_date, Species_group1, Species_group2, sign(log2FoldChange))]

DESeq2_results_with_taxonomy1 <- merge(
  DESeq2_results1,
  taxonomy_dt,
  by = "Feature_ID"
)

DESeq2_results2[padj <= 0.05][order(-abs(log2FoldChange))] %>% head(20)

DESeq2_results2[padj <= 0.05, .(.N), by = .(Collection_date, Species_group1, Species_group2, sign(log2FoldChange))]

DESeq2_results_with_taxonomy2 <- merge(
  DESeq2_results2,
  taxonomy_dt,
  by = "Feature_ID"
)
DESeq2_results3[padj <= 0.05][order(-abs(log2FoldChange))] %>% head(20)

DESeq2_results3[padj <= 0.05, .(.N), by = .(Collection_date, Species_group1, Species_group2, sign(log2FoldChange))]

DESeq2_results_with_taxonomy3 <- merge(
  DESeq2_results3,
  taxonomy_dt,
  by = "Feature_ID"
)
```

# remove NA and uncultured rows
```{r}
# Function to remove rows with values between +2 and -2 in the 'value_column'
remove_outliers <- function(dt, log2FoldChange) {
  dt <- dt[!(is.na(Family) | Family == "uncultured"| Family == "Unknown Family")]
  #dt <- dt[!(log2FoldChange >= -8 & log2FoldChange <= 8)]
  return(dt)
}

# Remove NA and uncultured rows, and outliers for each data.table
DESeq2_results_with_taxonomy1 <- remove_outliers(DESeq2_results_with_taxonomy1, log2FoldChange)
DESeq2_results_with_taxonomy2 <- remove_outliers(DESeq2_results_with_taxonomy2, log2FoldChange)
DESeq2_results_with_taxonomy3 <- remove_outliers(DESeq2_results_with_taxonomy3, log2FoldChange)


```




# For each file individually:  extract data and prepare matrix for the heatmap
```{r}
# Filter the molten data table based on the padj column
filtered_data1 <- subset(DESeq2_results_with_taxonomy1, padj < 0.05)
filtered_data2 <- subset(DESeq2_results_with_taxonomy2, padj < 0.05)
filtered_data3 <- subset(DESeq2_results_with_taxonomy3, padj < 0.05)

write_tsv(filtered_data1, file.path(DiffAbund_DIR, "filtered_DESeq2_results_with_taxonomy_Ac_E25.tsv"))
write_tsv(filtered_data2, file.path(DiffAbund_DIR, "filtered_DESeq2_results_with_taxonomy_Ac_UV7.tsv"))
write_tsv(filtered_data3, file.path(DiffAbund_DIR, "filtered_DESeq2_results_with_taxonomy_SC_Ac.tsv"))

# Assuming DESeq2_results_with_taxonomy is your data.table
# First, let's pivot the data to have Feature_ID as rows and Collection_date as columns
#heatmap_data1 <- dcast(filtered_data1, Family ~ Collection_date, value.var = "log2FoldChange", fun.aggregate = mean)
#heatmap_data2 <- dcast(filtered_data2, Family ~ Collection_date, value.var = "log2FoldChange", fun.aggregate = mean)
#heatmap_data3 <- dcast(filtered_data3, Family ~ Collection_date, value.var = "log2FoldChange", fun.aggregate = mean)
heatmap_data1 <- dcast(filtered_data1, Genus ~ Collection_date, value.var = "log2FoldChange", fun.aggregate = mean)
heatmap_data2 <- dcast(filtered_data2, Genus ~ Collection_date, value.var = "log2FoldChange", fun.aggregate = mean)
heatmap_data3 <- dcast(filtered_data3, Genus ~ Collection_date, value.var = "log2FoldChange", fun.aggregate = mean)

# Manually reorder the columns based on custom order
#heatmap_data <- heatmap_data[, order(match(names(heatmap_data), custom_order)), with = FALSE]

# Extract Feature_ID column for row names
row_names1 <- heatmap_data1$Genus
row_names2 <- heatmap_data2$Genus
row_names3 <- heatmap_data3$Genus

# Remove Feature_ID column from data
heatmap_data1 <- heatmap_data1[, -1, with = FALSE]
heatmap_data2 <- heatmap_data2[, -1, with = FALSE]
heatmap_data3 <- heatmap_data3[, -1, with = FALSE]

# Convert the data.table to a matrix
heatmap_matrix1 <- as.matrix(heatmap_data1)
heatmap_matrix2 <- as.matrix(heatmap_data2)
heatmap_matrix3 <- as.matrix(heatmap_data3)

# to circumvent any problems caused by NAs, set all to 0
heatmap_matrix1[is.nan(heatmap_matrix1)] <- 0
heatmap_matrix2[is.nan(heatmap_matrix2)] <- 0
heatmap_matrix3[is.nan(heatmap_matrix3)] <- 0

#write_tsv(DESeq2_results_with_taxonomy1, file.path(DiffAbund_DIR, "DESeq2_results_with_taxonomySC_1.tsv"))
#write_tsv(DESeq2_results_with_taxonomy2, file.path(DiffAbund_DIR, "DESeq2_results_with_taxonomySC_2.tsv"))
#write_tsv(DESeq2_results_with_taxonomy3, file.path(DiffAbund_DIR, "DESeq2_results_with_taxonomySC_3.tsv"))
```

# reorder rows in descending order
```{r}
# Calculate row-wise sum or maximum
row_sums1 <- rowSums(heatmap_matrix1, na.rm = TRUE)  # Sum of values in each row, excluding NA
row_sums2 <- rowSums(heatmap_matrix2, na.rm = TRUE) 
row_sums3 <- rowSums(heatmap_matrix3, na.rm = TRUE) 
# If you want to use maximum instead of sum:
# row_max <- apply(heatmap_matrix1, 1, max)  # Maximum value in each row

# Order rows according to the row-wise sums or maxima
ordered_rows1 <- order(row_sums1, decreasing = TRUE)  # For sum, use decreasing = TRUE; for max, it's optional
ordered_rows2 <- order(row_sums2, decreasing = TRUE)
ordered_rows3 <- order(row_sums3, decreasing = TRUE)

# Reorder heatmap_matrix1 based on the ordered rows
heatmap_matrix_reordered1 <- heatmap_matrix1[ordered_rows1, ]
heatmap_matrix_reordered2 <- heatmap_matrix2[ordered_rows2, ]
heatmap_matrix_reordered3 <- heatmap_matrix3[ordered_rows3, ]

### Find median for each matrix ###
# Calculate row sums
heat_sums1 <- rowSums(heatmap_matrix_reordered1, na.rm = TRUE)
heat_sums2 <- rowSums(heatmap_matrix_reordered2, na.rm = TRUE)
heat_sums3 <- rowSums(heatmap_matrix_reordered3, na.rm = TRUE)

# Add row sums as a new column to the matrix
heatmap_matrix_reordered1_with_sums1 <- cbind(heatmap_matrix_reordered1, RowSums = heat_sums1)
heatmap_matrix_reordered1_with_sums2 <- cbind(heatmap_matrix_reordered2, RowSums = heat_sums2)
heatmap_matrix_reordered1_with_sums3 <- cbind(heatmap_matrix_reordered3, RowSums = heat_sums3)

# View the matrix with the new column
print(heatmap_matrix_reordered1_with_sums1)
median(heat_sums1)

print(heatmap_matrix_reordered1_with_sums2)
median(heat_sums2)

print(heatmap_matrix_reordered1_with_sums3)
median(heat_sums3)


# Calculate the sum of each individual column
column_sums1 <- colSums(heatmap_matrix_reordered1_with_sums1, na.rm = TRUE)
column_sums2 <- colSums(heatmap_matrix_reordered1_with_sums2, na.rm = TRUE)
column_sums3 <- colSums(heatmap_matrix_reordered1_with_sums3, na.rm = TRUE)

# Print the sum of each individual column
print(column_sums1)
print(column_sums2)
print(column_sums3)

```

# Heatmap 

```{r}
# Define breaks for the color scale
breaks <- seq(-25, 25, by = 1)  # Adjust the range and interval as needed
my_palette <- colorRampPalette(c("navy", "white", "firebrick3"))(49) # 49 number of colour break, important to have an uneven number, so that pure white exists in the middle for "0"s.

# Create heatmaps with consistent color scale
plot1 <- pheatmap(heatmap_matrix1,
                  #cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  labels_row = row_names1,
                  main = "E25 v. Ac",
                  fontsize_row = 7,
                  fontsize_col = 8,
                  cellwidth = 20,
                  cellheight = 7,
                  color = my_palette,
                  border_color= "white",
                  breaks = breaks)

ggsave(
  file.path(DiffAbund_DIR, g("{PROJECT_NAME}_DeSeq_clustered_Heatmap_E25_Ac.png")),
  plot = plot1,
  width = 14,
  height = 17,
  units = "cm",
  dpi = 600
)

plot2 <- pheatmap(heatmap_matrix2,
                  #cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  labels_row = row_names2,
                  main = "UV7 v. Ac",
                  fontsize_row = 7,
                  fontsize_col = 8,
                  cellwidth = 20,
                  cellheight = 7,
                  color = my_palette,
                  border_color= "white",
                  breaks = breaks)

ggsave(
  file.path(DiffAbund_DIR, g("{PROJECT_NAME}_DeSeq_clustered_Heatmap_UV7_Ac.png")),
  plot = plot2,
  width = 14,
  height = 20,
  units = "cm",
  dpi = 600
)

plot3 <- pheatmap(heatmap_matrix3,
                  #cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  labels_row = row_names3,
                  main = "SC v. Ac",
                  fontsize_row = 7,
                  fontsize_col = 8,
                  cellwidth = 20,
                  cellheight = 7,
                  color = my_palette,
                  border_color= "white",
                  breaks = breaks)

ggsave(
  file.path(PLOTS_DIR, g("{PROJECT_NAME}_DeSeq_clustered_Heatmap_SC_Ac.svg")),
  plot = plot3,
  width = 18,
  height = 25,
  units = "cm",
  dpi = 600
)

```





######################################################################################################################################################################
######################################################################################################################################################################
# Rows ordered by rowsum highest to lowest
######################################################################################################################################################################

```{r}
# Create heatmaps with consistent color scale
plot1 <- pheatmap(heatmap_matrix_reordered1,
                  cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  labels_row = row_names1[ordered_rows1],  # Set row names based on the new order
                  main = "E25 v. Ac",
                  fontsize_row = 7,
                  fontsize_col = 8,
                  cellwidth = 20,
                  cellheight = 7,
                  breaks = breaks)
ggsave(
  file.path(PLOTS_DIR, g("{PROJECT_NAME}_DeSeq_Heatmap_E25_Ac.png")),
  plot = plot2,
  width = 9,
  height = 17,
  units = "cm",
  dpi = 600
)

plot2 <- pheatmap(heatmap_matrix_reordered2,
         cluster_rows = FALSE,  # Cluster rows
         cluster_cols = FALSE,  # Cluster columns
         #clustering_distance_rows = "correlation",
        labels_row = row_names2[ordered_rows2],  # Set row names based on the new order
         main = "UV7 v. Ac",
         fontsize_row = 7,  # Adjust font size for row labels
         fontsize_col = 8,  # Adjust font size for column labels
  #color = viridis::turbo(20),
  cellwidth = 20,
  cellheight = 7,
  #main = g("{PROJECT_NAME}"),
  # to show the values in the cells:
  # display_numbers = TRUE,
  # number_color = "white"
  # to export the heatmap:
  #filename = file.path(PLOTS_DIR, g("{PROJECT_NAME}_heatmap_Geli.pdf"))
)
plot3 <- pheatmap(heatmap_matrix_reordered3,
         cluster_rows = FALSE,  # Cluster rows
         cluster_cols = FALSE,  # Cluster columns
         #clustering_distance_rows = "correlation",
         labels_row = row_names3[ordered_rows3],  # Set row names based on the new order
         main = "UV7 v. E25",
         fontsize_row = 7,  # Adjust font size for row labels
         fontsize_col = 8,  # Adjust font size for column labels
  #color = viridis::turbo(20),
  cellwidth = 20,
  cellheight = 7,
  #main = g("{PROJECT_NAME}"),
  # to show the values in the cells:
  # display_numbers = TRUE,
  # number_color = "white"
  # to export the heatmap:
  #filename = file.path(PLOTS_DIR, g("{PROJECT_NAME}_heatmap_Geli.pdf"))
)


# Arrange plots side by side
#combined_plot <- gridExtra::grid.arrange(plot1, plot2, plot3,  ncol = 3, widths = c(1, 1, 1))


ggsave(
  file.path(PLOTS_DIR, g("{PROJECT_NAME}_DeSeq_Heatmap_UV7_Ac.png")),
  plot = plot2,
  width = 9,
  height = 17,
  units = "cm",
  dpi = 600
)
```


```{r}
library(gridExtra)

# Get unique levels of the variable
variable_levels <- unique(variable)

# Create an empty list to store the heatmaps
heatmap_list <- list()

# Iterate over each level of the variable
for (level in variable_levels) {
  # Filter the data for the current level
  filtered_data <- heatmap_matrix[variable == level, ]
  
  # Create the heatmap for the filtered data
  heatmap <- pheatmap(filtered_data,
                      cluster_rows = FALSE,
                      cluster_cols = FALSE,
                      labels_row = row_names,
                      main = paste("Heatmap for", level),
                      fontsize_row = 7,
                      fontsize_col = 8,
                      cellwidth = 20,
                      cellheight = 7)
  
  # Store the heatmap in the list
  heatmap_list[[level]] <- heatmap
}

# Plot heatmap using pheatmap
pheatmap(heatmap_matrix,
         cluster_rows = TRUE,  # Cluster rows
         cluster_cols = TRUE,  # Cluster columns
         clustering_distance_rows = "correlation",
         labels_row = row_names,  # Set row names
         main = "combined heatmap",
         fontsize_row = 7,  # Adjust font size for row labels
         fontsize_col = 8,  # Adjust font size for column labels
  #color = viridis::turbo(20),
  cellwidth = 20,
  cellheight = 7,
  #main = g("{PROJECT_NAME}"),
  # to show the values in the cells:
  # display_numbers = TRUE,
  # number_color = "white"
  # to export the heatmap:
  #filename = file.path(PLOTS_DIR, g("{PROJECT_NAME}_heatmap_Geli.pdf"))
)

ggsave(
  file.path(PLOTS_DIR, g("{PROJECT_NAME}_DeSeq_Heatmap_UV7_E25.png")),
  plot = plot3,
  width = 12,
  height = 27,
  units = "cm",
  dpi = 600
)
```

# add abundance data to the DESeq results
```{r}
# Extract the relevant columns from SE
abundance_data <- counts(SE)
collection_dates <- colData(SE)$collection_date
feature_ids <- rownames(abundance_data)
Species <- colData(SE)$Species
rowData_SE <- rowData(SE)[, c("ASV_ID", "Genus")]
# Convert DFrame to data.table
rowData_DT <- data.table::data.table(
  Feature_ID = rowData_SE$ASV_ID,
  Genus = rowData_SE$Genus
)

# Create a data.table from the extracted columns
SE_dt <- data.table(
  Collection_date = rep(collection_dates, each = nrow(abundance_data)),
  Feature_ID = rep(feature_ids, length(collection_dates)),
  abundance = as.vector(t(abundance_data)),
  Species = rep(Species, each = nrow(abundance_data))
)
# Define a key for merging
setkey(SE_dt, Collection_date, Feature_ID, Species)

# Subset SE data.table with only relevant columns
SE_subset <- SE_dt[, .(Collection_date, Feature_ID, abundance, Species)]


merged_results1 <- merge(
  SE_subset, 
  rowData_DT,
  by = c("Feature_ID"), 
  all = FALSE,  # Keep only matching rows
  sort = FALSE  # Prevent sorting as we've already set keys
)
merged_results1 <- na.omit(merged_results1, cols = "Genus")
library(tidyverse)
merged_results1_summary <- merged_results1 %>% # the names of the new data frame and the data frame to be summarised
  group_by(Collection_date,Species, Genus) %>%   # the grouping variable
  summarise(abundance = mean(abundance, na.rm = TRUE),  # calculates the mean of each group
            sd_value = sd(abundance, na.rm = TRUE), # calculates the standard deviation of each group
            n_value = sum(!is.na(abundance)),  # calculates the sample size per group
            SE_value = sd(abundance, na.rm = TRUE)/sqrt(n())) # calculates the standard error of each group

# Filter rows where abundance values are over 100,000,000
merged_results1_summary_filtered <- merged_results1_summary %>%
  filter(abundance > 1000000000)

merged_results <- data.table::data.table(
  Collection_date = merged_results1_summary_filtered$Collection_date,
  Genus = merged_results1_summary_filtered$Genus,
  abundance = merged_results1_summary_filtered$abundance,
  Species = merged_results1_summary_filtered$Species
)

# Print the first few rows of the merged results
print(head(merged_results1_summary_filtered))
print(head(merged_results2))
print(head(merged_results3))

merged_results_day11 <- subset(merged_results, Collection_date == "11")
merged_results_day11 <- subset(merged_results1, Collection_date == "11")
merged_results_day11 <- subset(merged_results_day11, !(Genus == "NA" | Genus == "uncultured" | Genus == "Unknown"))

chosen_genera <- c("Mucilaginibacter","Chitinophaga","Edaphobaculum","Chthoniobacter","Taibaiella","Reyranella","Jatrophihabitans","Kaistia","Granulicella","Edaphobacter","Curtobacterium","Burkholderia-Caballeronia-Paraburkholderia")
filtered_data11 <- merged_results_day11[Genus %in% chosen_genera]

# Exclude rows with Species name "E25" from merged_results
merged_results1_filtered1 <- merged_results[Species != "Ac", ]
merged_results1_filtered2 <- merged_results1_filtered1[Species != "SC"]
merged_results1_filtered <- merged_results1_filtered2[Species != "UV7"]
merged_results1_filtered <- subset(merged_results1_filtered, Collection_date == "11")

merged_results2_filtered1 <- merged_results[Species != "Ac"]
merged_results2_filtered2 <- merged_results2_filtered1[Species != "SC"]
merged_results2_filtered <- merged_results2_filtered2[Species != "E25"]
merged_results2_filtered <- subset(merged_results2_filtered, Collection_date == "11")

merged_results3_filtered1 <- merged_results[Species != "UV7"]
merged_results3_filtered2 <- merged_results3_filtered1[Species != "SC"]
merged_results3_filtered <- merged_results3_filtered2[Species != "E25"]
merged_results3_filtered <- subset(merged_results3_filtered, Collection_date == "11")

merged_results4_filtered1 <- merged_results[Species != "UV7"]
merged_results4_filtered2 <- merged_results4_filtered1[Species != "Ac"]
merged_results4_filtered <- merged_results4_filtered2[Species != "E25"]
merged_results4_filtered <- subset(merged_results4_filtered, Collection_date == "11")

# Print the first few rows of the filtered merged results
print(head(merged_results1_filtered))
print(head(merged_results2_filtered))

# remove unclutured
merged_results1_filtered <- subset(merged_results1_filtered, !(Genus == "NA" | Genus == "uncultured" | Genus == "Unknown"))
merged_results2_filtered <- subset(merged_results2_filtered, !(Genus == "NA" | Genus == "uncultured" | Genus == "Unknown"))
merged_results3_filtered <- subset(merged_results3_filtered, !(Genus == "NA" | Genus == "uncultured" | Genus == "Unknown"))
merged_results4_filtered <- subset(merged_results4_filtered, !(Genus == "NA" | Genus == "uncultured" | Genus == "Unknown"))


my_color = c("Mucilaginibacter" ="hotpink",
               "Chitinophaga" = "chartreuse2",
               "Chthoniobacter"= "steelblue1",
               "Edaphobaculum" ="yellow2",
             "Taibaiella"="grey",
             "Reyranella"="grey",
             "Jatrophihabitans"="grey",
             "Kaistia"="grey",
             "Granulicella"="grey",
             "Edaphobacter"="grey",
             "Curtobacterium"="grey",
             "Burkholderia-Caballeronia-Paraburkholderia"="grey")


```

# create the barplot for only day 11
```{r}
#barplot_all11 <- 
  ggplot(
  data = filtered_data11,
  mapping = aes(
    x = Genus,
    y = abundance,
    fill = Genus
  )
) +
    scale_color_manual(values = my_color)+
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Species)+
  #scale_y_continuous(limits = NULL, breaks = NULL, labels = rev(levels(merged_results1_filtered1$Family))) + # Reversing the order of y-axis labels
  coord_flip() +
      #scale_y_continuous(breaks = c(10000000000, 100000000000,1000000000000, 10000000000000))+
  theme(
   axis.text.x = element_text(angle = 90,  hjust = 1, vjust = 0.5, size = 6),
   axis.title = element_text(),
   axis.text.y = element_text(size = 6), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


ggsave(
  file.path(PLOTS_DIR, g("{PROJECT_NAME}_Abundances_Genera_T11.png")),
  plot = barplot_all11,
  width = 15,
  height = 8,
  units = "cm",
  dpi = 600
)


```



# Create the barplot for abundance
```{r}

barplot_abundance1_1 <- ggplot(
  data = merged_results1_filtered1[padj <= 0.05],
  mapping = aes(
    x = Family,
    y = abundance,
    fill = Family
  )
) +
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Collection_date)+
  #scale_y_continuous(limits = NULL, breaks = NULL, labels = rev(levels(merged_results1_filtered1$Family))) + # Reversing the order of y-axis labels
  coord_flip() +
  theme(
   axis.text.x = element_text(angle = 90,  hjust = 1, vjust = 0.5, size = 4),
   axis.title = element_text(),
   #axis.text.y = element_blank(), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )+
  labs(y="Abundance E25")
  
barplot_abundance1_2 <- ggplot(
  data = merged_results1_filtered2[padj <= 0.05],
  mapping = aes(
    x = Family,
    y = abundance,
    fill = Family
  )
) +
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Collection_date
  ) +
  coord_flip() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 4),
    #labs(x = "Abundance UV7"),  # Set x-axis label
    axis.text.y = element_blank(), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )+
  labs(y="Abundance Ac")

barplot_abundance2_1 <- ggplot(
  data = merged_results2_filtered1[padj <= 0.05],
  mapping = aes(
    x = Family,
    y = abundance,
    fill = Family
  )
) +
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Collection_date
  ) +
  coord_flip() +
  theme(
   axis.text.x = element_text(angle = 90,  hjust = 1, vjust = 0.5, size = 4),
   axis.title = element_text(),
   axis.text.y = element_blank(), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )+
  labs(y="Abundance UV7")
  
barplot_abundance2_2 <- ggplot(
  data = merged_results2_filtered2[padj <= 0.05],
  mapping = aes(
    x = Family,
    y = abundance,
    fill = Family
  )
) +
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Collection_date
  ) +
  coord_flip() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 4),
    #labs(x = "Abundance UV7"),  # Set x-axis label
    axis.text.y = element_blank(), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )+
  labs(y="Abundance Ac")

barplot_abundance3_1 <- ggplot(
  data = merged_results3_filtered1[padj <= 0.05],
  mapping = aes(
    x = Family,
    y = abundance,
    fill = Family
  )
) +
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Collection_date
  ) +
  coord_flip() +
  theme(
   axis.text.x = element_text(angle = 90,  hjust = 1, vjust = 0.5, size = 4),
   axis.title = element_text(),
   axis.text.y = element_blank(), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )+
  labs(y="Abundance E25")
  
barplot_abundance3_2 <- ggplot(
  data = merged_results3_filtered2[padj <= 0.05],
  mapping = aes(
    x = Family,
    y = abundance,
    fill = Family
  )
) +
  geom_bar(stat = "identity") +
  facet_grid(
    facets = ~Collection_date
  ) +
  coord_flip() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 4),
    #labs(x = "Abundance UV7"),  # Set x-axis label
    axis.text.y = element_blank(), 
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )+
  labs(y="Abundance UV7")
  
# Arrange plots side by side
combined_plot <- gridExtra::grid.arrange(barplot_abundance1_1, barplot_abundance1_2, barplot_abundance2_1, barplot_abundance2_2, barplot_abundance3_1, barplot_abundance3_2,  ncol = 6, widths = c(1, 1, 1, 1, 1, 1))
```
